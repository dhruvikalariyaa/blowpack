{"ast":null,"code":"\"use strict\";\n\n// Copyright 2021 Google LLC\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.IdentityPoolClient = void 0;\nconst baseexternalclient_1 = require(\"./baseexternalclient\");\nconst util_1 = require(\"../util\");\nconst filesubjecttokensupplier_1 = require(\"./filesubjecttokensupplier\");\nconst urlsubjecttokensupplier_1 = require(\"./urlsubjecttokensupplier\");\nconst certificatesubjecttokensupplier_1 = require(\"./certificatesubjecttokensupplier\");\nconst stscredentials_1 = require(\"./stscredentials\");\nconst gaxios_1 = require(\"gaxios\");\n/**\n * Defines the Url-sourced and file-sourced external account clients mainly\n * used for K8s and Azure workloads.\n */\nclass IdentityPoolClient extends baseexternalclient_1.BaseExternalAccountClient {\n  subjectTokenSupplier;\n  /**\n   * Instantiate an IdentityPoolClient instance using the provided JSON\n   * object loaded from an external account credentials file.\n   * An error is thrown if the credential is not a valid file-sourced or\n   * url-sourced credential or a workforce pool user project is provided\n   * with a non workforce audience.\n   * @param options The external account options object typically loaded\n   *   from the external account JSON credential file. The camelCased options\n   *   are aliases for the snake_cased options.\n   */\n  constructor(options) {\n    super(options);\n    const opts = (0, util_1.originalOrCamelOptions)(options);\n    const credentialSource = opts.get('credential_source');\n    const subjectTokenSupplier = opts.get('subject_token_supplier');\n    // Validate credential sourcing configuration.\n    if (!credentialSource && !subjectTokenSupplier) {\n      throw new Error('A credential source or subject token supplier must be specified.');\n    }\n    if (credentialSource && subjectTokenSupplier) {\n      throw new Error('Only one of credential source or subject token supplier can be specified.');\n    }\n    if (subjectTokenSupplier) {\n      this.subjectTokenSupplier = subjectTokenSupplier;\n      this.credentialSourceType = 'programmatic';\n    } else {\n      const credentialSourceOpts = (0, util_1.originalOrCamelOptions)(credentialSource);\n      const formatOpts = (0, util_1.originalOrCamelOptions)(credentialSourceOpts.get('format'));\n      // Text is the default format type.\n      const formatType = formatOpts.get('type') || 'text';\n      const formatSubjectTokenFieldName = formatOpts.get('subject_token_field_name');\n      if (formatType !== 'json' && formatType !== 'text') {\n        throw new Error(`Invalid credential_source format \"${formatType}\"`);\n      }\n      if (formatType === 'json' && !formatSubjectTokenFieldName) {\n        throw new Error('Missing subject_token_field_name for JSON credential_source format');\n      }\n      const file = credentialSourceOpts.get('file');\n      const url = credentialSourceOpts.get('url');\n      const certificate = credentialSourceOpts.get('certificate');\n      const headers = credentialSourceOpts.get('headers');\n      if (file && url || url && certificate || file && certificate) {\n        throw new Error('No valid Identity Pool \"credential_source\" provided, must be either file, url, or certificate.');\n      } else if (file) {\n        this.credentialSourceType = 'file';\n        this.subjectTokenSupplier = new filesubjecttokensupplier_1.FileSubjectTokenSupplier({\n          filePath: file,\n          formatType: formatType,\n          subjectTokenFieldName: formatSubjectTokenFieldName\n        });\n      } else if (url) {\n        this.credentialSourceType = 'url';\n        this.subjectTokenSupplier = new urlsubjecttokensupplier_1.UrlSubjectTokenSupplier({\n          url: url,\n          formatType: formatType,\n          subjectTokenFieldName: formatSubjectTokenFieldName,\n          headers: headers,\n          additionalGaxiosOptions: IdentityPoolClient.RETRY_CONFIG\n        });\n      } else if (certificate) {\n        this.credentialSourceType = 'certificate';\n        const certificateSubjecttokensupplier = new certificatesubjecttokensupplier_1.CertificateSubjectTokenSupplier({\n          useDefaultCertificateConfig: certificate.use_default_certificate_config,\n          certificateConfigLocation: certificate.certificate_config_location,\n          trustChainPath: certificate.trust_chain_path\n        });\n        this.subjectTokenSupplier = certificateSubjecttokensupplier;\n      } else {\n        throw new Error('No valid Identity Pool \"credential_source\" provided, must be either file, url, or certificate.');\n      }\n    }\n  }\n  /**\n   * Triggered when a external subject token is needed to be exchanged for a GCP\n   * access token via GCP STS endpoint. Gets a subject token by calling\n   * the configured {@link SubjectTokenSupplier}\n   * @return A promise that resolves with the external subject token.\n   */\n  async retrieveSubjectToken() {\n    const subjectToken = await this.subjectTokenSupplier.getSubjectToken(this.supplierContext);\n    if (this.subjectTokenSupplier instanceof certificatesubjecttokensupplier_1.CertificateSubjectTokenSupplier) {\n      const mtlsAgent = await this.subjectTokenSupplier.createMtlsHttpsAgent();\n      this.stsCredential = new stscredentials_1.StsCredentials({\n        tokenExchangeEndpoint: this.getTokenUrl(),\n        clientAuthentication: this.clientAuth,\n        transporter: new gaxios_1.Gaxios({\n          agent: mtlsAgent\n        })\n      });\n      this.transporter = new gaxios_1.Gaxios({\n        ...(this.transporter.defaults || {}),\n        agent: mtlsAgent\n      });\n    }\n    return subjectToken;\n  }\n}\nexports.IdentityPoolClient = IdentityPoolClient;","map":{"version":3,"names":["Object","defineProperty","exports","value","IdentityPoolClient","baseexternalclient_1","require","util_1","filesubjecttokensupplier_1","urlsubjecttokensupplier_1","certificatesubjecttokensupplier_1","stscredentials_1","gaxios_1","BaseExternalAccountClient","subjectTokenSupplier","constructor","options","opts","originalOrCamelOptions","credentialSource","get","Error","credentialSourceType","credentialSourceOpts","formatOpts","formatType","formatSubjectTokenFieldName","file","url","certificate","headers","FileSubjectTokenSupplier","filePath","subjectTokenFieldName","UrlSubjectTokenSupplier","additionalGaxiosOptions","RETRY_CONFIG","certificateSubjecttokensupplier","CertificateSubjectTokenSupplier","useDefaultCertificateConfig","use_default_certificate_config","certificateConfigLocation","certificate_config_location","trustChainPath","trust_chain_path","retrieveSubjectToken","subjectToken","getSubjectToken","supplierContext","mtlsAgent","createMtlsHttpsAgent","stsCredential","StsCredentials","tokenExchangeEndpoint","getTokenUrl","clientAuthentication","clientAuth","transporter","Gaxios","agent","defaults"],"sources":["E:/blowpack/frountend/node_modules/google-auth-library/build/src/auth/identitypoolclient.js"],"sourcesContent":["\"use strict\";\n// Copyright 2021 Google LLC\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.IdentityPoolClient = void 0;\nconst baseexternalclient_1 = require(\"./baseexternalclient\");\nconst util_1 = require(\"../util\");\nconst filesubjecttokensupplier_1 = require(\"./filesubjecttokensupplier\");\nconst urlsubjecttokensupplier_1 = require(\"./urlsubjecttokensupplier\");\nconst certificatesubjecttokensupplier_1 = require(\"./certificatesubjecttokensupplier\");\nconst stscredentials_1 = require(\"./stscredentials\");\nconst gaxios_1 = require(\"gaxios\");\n/**\n * Defines the Url-sourced and file-sourced external account clients mainly\n * used for K8s and Azure workloads.\n */\nclass IdentityPoolClient extends baseexternalclient_1.BaseExternalAccountClient {\n    subjectTokenSupplier;\n    /**\n     * Instantiate an IdentityPoolClient instance using the provided JSON\n     * object loaded from an external account credentials file.\n     * An error is thrown if the credential is not a valid file-sourced or\n     * url-sourced credential or a workforce pool user project is provided\n     * with a non workforce audience.\n     * @param options The external account options object typically loaded\n     *   from the external account JSON credential file. The camelCased options\n     *   are aliases for the snake_cased options.\n     */\n    constructor(options) {\n        super(options);\n        const opts = (0, util_1.originalOrCamelOptions)(options);\n        const credentialSource = opts.get('credential_source');\n        const subjectTokenSupplier = opts.get('subject_token_supplier');\n        // Validate credential sourcing configuration.\n        if (!credentialSource && !subjectTokenSupplier) {\n            throw new Error('A credential source or subject token supplier must be specified.');\n        }\n        if (credentialSource && subjectTokenSupplier) {\n            throw new Error('Only one of credential source or subject token supplier can be specified.');\n        }\n        if (subjectTokenSupplier) {\n            this.subjectTokenSupplier = subjectTokenSupplier;\n            this.credentialSourceType = 'programmatic';\n        }\n        else {\n            const credentialSourceOpts = (0, util_1.originalOrCamelOptions)(credentialSource);\n            const formatOpts = (0, util_1.originalOrCamelOptions)(credentialSourceOpts.get('format'));\n            // Text is the default format type.\n            const formatType = formatOpts.get('type') || 'text';\n            const formatSubjectTokenFieldName = formatOpts.get('subject_token_field_name');\n            if (formatType !== 'json' && formatType !== 'text') {\n                throw new Error(`Invalid credential_source format \"${formatType}\"`);\n            }\n            if (formatType === 'json' && !formatSubjectTokenFieldName) {\n                throw new Error('Missing subject_token_field_name for JSON credential_source format');\n            }\n            const file = credentialSourceOpts.get('file');\n            const url = credentialSourceOpts.get('url');\n            const certificate = credentialSourceOpts.get('certificate');\n            const headers = credentialSourceOpts.get('headers');\n            if ((file && url) || (url && certificate) || (file && certificate)) {\n                throw new Error('No valid Identity Pool \"credential_source\" provided, must be either file, url, or certificate.');\n            }\n            else if (file) {\n                this.credentialSourceType = 'file';\n                this.subjectTokenSupplier = new filesubjecttokensupplier_1.FileSubjectTokenSupplier({\n                    filePath: file,\n                    formatType: formatType,\n                    subjectTokenFieldName: formatSubjectTokenFieldName,\n                });\n            }\n            else if (url) {\n                this.credentialSourceType = 'url';\n                this.subjectTokenSupplier = new urlsubjecttokensupplier_1.UrlSubjectTokenSupplier({\n                    url: url,\n                    formatType: formatType,\n                    subjectTokenFieldName: formatSubjectTokenFieldName,\n                    headers: headers,\n                    additionalGaxiosOptions: IdentityPoolClient.RETRY_CONFIG,\n                });\n            }\n            else if (certificate) {\n                this.credentialSourceType = 'certificate';\n                const certificateSubjecttokensupplier = new certificatesubjecttokensupplier_1.CertificateSubjectTokenSupplier({\n                    useDefaultCertificateConfig: certificate.use_default_certificate_config,\n                    certificateConfigLocation: certificate.certificate_config_location,\n                    trustChainPath: certificate.trust_chain_path,\n                });\n                this.subjectTokenSupplier = certificateSubjecttokensupplier;\n            }\n            else {\n                throw new Error('No valid Identity Pool \"credential_source\" provided, must be either file, url, or certificate.');\n            }\n        }\n    }\n    /**\n     * Triggered when a external subject token is needed to be exchanged for a GCP\n     * access token via GCP STS endpoint. Gets a subject token by calling\n     * the configured {@link SubjectTokenSupplier}\n     * @return A promise that resolves with the external subject token.\n     */\n    async retrieveSubjectToken() {\n        const subjectToken = await this.subjectTokenSupplier.getSubjectToken(this.supplierContext);\n        if (this.subjectTokenSupplier instanceof certificatesubjecttokensupplier_1.CertificateSubjectTokenSupplier) {\n            const mtlsAgent = await this.subjectTokenSupplier.createMtlsHttpsAgent();\n            this.stsCredential = new stscredentials_1.StsCredentials({\n                tokenExchangeEndpoint: this.getTokenUrl(),\n                clientAuthentication: this.clientAuth,\n                transporter: new gaxios_1.Gaxios({ agent: mtlsAgent }),\n            });\n            this.transporter = new gaxios_1.Gaxios({\n                ...(this.transporter.defaults || {}),\n                agent: mtlsAgent,\n            });\n        }\n        return subjectToken;\n    }\n}\nexports.IdentityPoolClient = IdentityPoolClient;\n//# sourceMappingURL=identitypoolclient.js.map"],"mappings":"AAAA,YAAY;;AACZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACAA,MAAM,CAACC,cAAc,CAACC,OAAO,EAAE,YAAY,EAAE;EAAEC,KAAK,EAAE;AAAK,CAAC,CAAC;AAC7DD,OAAO,CAACE,kBAAkB,GAAG,KAAK,CAAC;AACnC,MAAMC,oBAAoB,GAAGC,OAAO,CAAC,sBAAsB,CAAC;AAC5D,MAAMC,MAAM,GAAGD,OAAO,CAAC,SAAS,CAAC;AACjC,MAAME,0BAA0B,GAAGF,OAAO,CAAC,4BAA4B,CAAC;AACxE,MAAMG,yBAAyB,GAAGH,OAAO,CAAC,2BAA2B,CAAC;AACtE,MAAMI,iCAAiC,GAAGJ,OAAO,CAAC,mCAAmC,CAAC;AACtF,MAAMK,gBAAgB,GAAGL,OAAO,CAAC,kBAAkB,CAAC;AACpD,MAAMM,QAAQ,GAAGN,OAAO,CAAC,QAAQ,CAAC;AAClC;AACA;AACA;AACA;AACA,MAAMF,kBAAkB,SAASC,oBAAoB,CAACQ,yBAAyB,CAAC;EAC5EC,oBAAoB;EACpB;AACJ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACIC,WAAWA,CAACC,OAAO,EAAE;IACjB,KAAK,CAACA,OAAO,CAAC;IACd,MAAMC,IAAI,GAAG,CAAC,CAAC,EAAEV,MAAM,CAACW,sBAAsB,EAAEF,OAAO,CAAC;IACxD,MAAMG,gBAAgB,GAAGF,IAAI,CAACG,GAAG,CAAC,mBAAmB,CAAC;IACtD,MAAMN,oBAAoB,GAAGG,IAAI,CAACG,GAAG,CAAC,wBAAwB,CAAC;IAC/D;IACA,IAAI,CAACD,gBAAgB,IAAI,CAACL,oBAAoB,EAAE;MAC5C,MAAM,IAAIO,KAAK,CAAC,kEAAkE,CAAC;IACvF;IACA,IAAIF,gBAAgB,IAAIL,oBAAoB,EAAE;MAC1C,MAAM,IAAIO,KAAK,CAAC,2EAA2E,CAAC;IAChG;IACA,IAAIP,oBAAoB,EAAE;MACtB,IAAI,CAACA,oBAAoB,GAAGA,oBAAoB;MAChD,IAAI,CAACQ,oBAAoB,GAAG,cAAc;IAC9C,CAAC,MACI;MACD,MAAMC,oBAAoB,GAAG,CAAC,CAAC,EAAEhB,MAAM,CAACW,sBAAsB,EAAEC,gBAAgB,CAAC;MACjF,MAAMK,UAAU,GAAG,CAAC,CAAC,EAAEjB,MAAM,CAACW,sBAAsB,EAAEK,oBAAoB,CAACH,GAAG,CAAC,QAAQ,CAAC,CAAC;MACzF;MACA,MAAMK,UAAU,GAAGD,UAAU,CAACJ,GAAG,CAAC,MAAM,CAAC,IAAI,MAAM;MACnD,MAAMM,2BAA2B,GAAGF,UAAU,CAACJ,GAAG,CAAC,0BAA0B,CAAC;MAC9E,IAAIK,UAAU,KAAK,MAAM,IAAIA,UAAU,KAAK,MAAM,EAAE;QAChD,MAAM,IAAIJ,KAAK,CAAC,qCAAqCI,UAAU,GAAG,CAAC;MACvE;MACA,IAAIA,UAAU,KAAK,MAAM,IAAI,CAACC,2BAA2B,EAAE;QACvD,MAAM,IAAIL,KAAK,CAAC,oEAAoE,CAAC;MACzF;MACA,MAAMM,IAAI,GAAGJ,oBAAoB,CAACH,GAAG,CAAC,MAAM,CAAC;MAC7C,MAAMQ,GAAG,GAAGL,oBAAoB,CAACH,GAAG,CAAC,KAAK,CAAC;MAC3C,MAAMS,WAAW,GAAGN,oBAAoB,CAACH,GAAG,CAAC,aAAa,CAAC;MAC3D,MAAMU,OAAO,GAAGP,oBAAoB,CAACH,GAAG,CAAC,SAAS,CAAC;MACnD,IAAKO,IAAI,IAAIC,GAAG,IAAMA,GAAG,IAAIC,WAAY,IAAKF,IAAI,IAAIE,WAAY,EAAE;QAChE,MAAM,IAAIR,KAAK,CAAC,gGAAgG,CAAC;MACrH,CAAC,MACI,IAAIM,IAAI,EAAE;QACX,IAAI,CAACL,oBAAoB,GAAG,MAAM;QAClC,IAAI,CAACR,oBAAoB,GAAG,IAAIN,0BAA0B,CAACuB,wBAAwB,CAAC;UAChFC,QAAQ,EAAEL,IAAI;UACdF,UAAU,EAAEA,UAAU;UACtBQ,qBAAqB,EAAEP;QAC3B,CAAC,CAAC;MACN,CAAC,MACI,IAAIE,GAAG,EAAE;QACV,IAAI,CAACN,oBAAoB,GAAG,KAAK;QACjC,IAAI,CAACR,oBAAoB,GAAG,IAAIL,yBAAyB,CAACyB,uBAAuB,CAAC;UAC9EN,GAAG,EAAEA,GAAG;UACRH,UAAU,EAAEA,UAAU;UACtBQ,qBAAqB,EAAEP,2BAA2B;UAClDI,OAAO,EAAEA,OAAO;UAChBK,uBAAuB,EAAE/B,kBAAkB,CAACgC;QAChD,CAAC,CAAC;MACN,CAAC,MACI,IAAIP,WAAW,EAAE;QAClB,IAAI,CAACP,oBAAoB,GAAG,aAAa;QACzC,MAAMe,+BAA+B,GAAG,IAAI3B,iCAAiC,CAAC4B,+BAA+B,CAAC;UAC1GC,2BAA2B,EAAEV,WAAW,CAACW,8BAA8B;UACvEC,yBAAyB,EAAEZ,WAAW,CAACa,2BAA2B;UAClEC,cAAc,EAAEd,WAAW,CAACe;QAChC,CAAC,CAAC;QACF,IAAI,CAAC9B,oBAAoB,GAAGuB,+BAA+B;MAC/D,CAAC,MACI;QACD,MAAM,IAAIhB,KAAK,CAAC,gGAAgG,CAAC;MACrH;IACJ;EACJ;EACA;AACJ;AACA;AACA;AACA;AACA;EACI,MAAMwB,oBAAoBA,CAAA,EAAG;IACzB,MAAMC,YAAY,GAAG,MAAM,IAAI,CAAChC,oBAAoB,CAACiC,eAAe,CAAC,IAAI,CAACC,eAAe,CAAC;IAC1F,IAAI,IAAI,CAAClC,oBAAoB,YAAYJ,iCAAiC,CAAC4B,+BAA+B,EAAE;MACxG,MAAMW,SAAS,GAAG,MAAM,IAAI,CAACnC,oBAAoB,CAACoC,oBAAoB,CAAC,CAAC;MACxE,IAAI,CAACC,aAAa,GAAG,IAAIxC,gBAAgB,CAACyC,cAAc,CAAC;QACrDC,qBAAqB,EAAE,IAAI,CAACC,WAAW,CAAC,CAAC;QACzCC,oBAAoB,EAAE,IAAI,CAACC,UAAU;QACrCC,WAAW,EAAE,IAAI7C,QAAQ,CAAC8C,MAAM,CAAC;UAAEC,KAAK,EAAEV;QAAU,CAAC;MACzD,CAAC,CAAC;MACF,IAAI,CAACQ,WAAW,GAAG,IAAI7C,QAAQ,CAAC8C,MAAM,CAAC;QACnC,IAAI,IAAI,CAACD,WAAW,CAACG,QAAQ,IAAI,CAAC,CAAC,CAAC;QACpCD,KAAK,EAAEV;MACX,CAAC,CAAC;IACN;IACA,OAAOH,YAAY;EACvB;AACJ;AACA5C,OAAO,CAACE,kBAAkB,GAAGA,kBAAkB","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}